name: Issue Action

on:
  issues:
    types: [labeled, unlabeled]

jobs:
  manage-milestones:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Add High Priority Milestone
      if: github.event.action == 'labeled' && contains(github.event.label.name, 'P1')
      uses: actions/github-script@v7
      with:
        script: |
          const label = context.payload.label.name;
          if (label === 'P1') {
            const issue = context.issue;
            const milestones = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const milestone = milestones.data.find(m => m.title === 'High Priority');
            if (milestone) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                milestone: milestone.number
              });
            }
          }

    - name: Remove "High Priority" milestone from issues that remove the "P1" label
      if: github.event.action == 'unlabeled'
      uses: actions/github-script@v7
      with:
        script: |
          const label = context.payload.label.name;
          if (label === 'P1') {
            const issue = context.issue;
            const milestones = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const milestone = milestones.data.find(m => m.title === 'High Priority');
            if (milestone) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                milestone: null
              });
            }
          }
